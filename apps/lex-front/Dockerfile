FROM node:18-alpine

# Рабочая директория внутри контейнера
WORKDIR /app

# -------- УСТАНОВКА ЗАВИСИМОСТЕЙ --------
# Копируем package*.json отдельно, чтобы кэшировать npm ci
COPY package*.json ./

# Ставим prod-зависимости
RUN npm ci --no-audit --no-fund

# -------- КОД ПРОЕКТА --------
# Копируем остальной проект
COPY . .

# -------- СБОРКА NEXT --------
RUN npm run build

# -------- РАНТАЙМ --------
ENV NODE_ENV=production
# дефолтный порт; если хостинг задаст свой PORT, он его переопределит
ENV PORT=3000

# Экспортируем порт для оркестратора
EXPOSE 3000

# Запускаем Next, используя переменную PORT (дефолт 3000)
CMD ["sh", "-c", "npx next start -H 0.0.0.0 -p ${PORT:-3000}"]
